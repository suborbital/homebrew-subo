name: New PR on dispatch
on:
  repository_dispatch:
    types: [subo-release]

jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v3
      - name: Double check sha and tag
        run: |
          curl -L -o subo.tar.gz https://download.suborbital.network/subo/brew/${{ github.event.client_payload.tag }}
          echo ${{ github.event.client_payload.sha }} subo.tar.gz | sha256sum --check
          rm subo.tar.gz
      - name: Creates new file
        run: |
          sed 's/<<<tag>>>/${{ github.event.client_payload.tag }}/g' .github/actions/formula.tmpl > ./Formula/subo.rb
          sed -i 's/<<<sha256>>>/${{ github.event.client_payload.sha }}/g' ./Formula/subo.rb
      - name: Creates PR
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: '[Auto] Update homebrew formula to version v${{ github.event.client_payload.tag }}'
          committer: Github <noreply@github.com>
          branch: brew-on-release-${{ github.event.client_payload.tag }}-yaml
          delete-branch: true
          title: '[Auto] Update formula to version v${{ github.event.client_payload.tag }} after subo release'
          body: |
            Update formula after release at ${{ github.event.client_payload.release_url }}

            Auto-generated by Github action.
          labels: |
            automated pr
          draft: false